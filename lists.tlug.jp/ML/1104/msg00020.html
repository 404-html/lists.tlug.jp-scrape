<!-- MHonArc v2.6.16 -->
<!--X-Subject: [tlug] Monkey vs Apache!!! Fight! -->
<!--X-From-R13: Enpu Xboo <fnpuN77um.wc> -->
<!--X-Date: Wed, 06 Apr 2011 13:13:12 +0900 -->
<!--X-Message-Id: BANLkTimjpTEESJrzDcVNDmXQH1CEqKA11Q@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>TLUG Mailing List</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="Author" content="Jim Tittsler - listmaster TLUG">
  <meta http-equiv="keywords" content="Tokyo Linux Users Group mailing list archive.">
</head>
 
<body bgcolor="#FFFFFF" text="#000000" BACKGROUND="../back3grnd.gif">
<BLOCKQUOTE>
<CENTER><IMG SRC="../tlug_logo.gif"><BR>Mailing List Archive</CENTER>
<P>
<TABLE BGCOLOR="#FFFF66" BORDER=1 COLS=1 WIDTH="90%" CLASS=navbar>
<TR>
<TD>&nbsp;&nbsp;
<FONT FACE="Verdana, Lucida Sans, Arial, Helvetica, Geneva, sans-serif"><SMALL>
<A HREF="../../index.html" TITLE="Tokyo Linux Users Group Page">
<STRONG>tlug.jp</STRONG></A> 
<IMG SRC="../../images/arrow_yellow.gif" WIDTH=13 HEIGHT=9 ALIGN=bottom ALT="-&gt;">
<A HREF="../../list.html" TITLE="Mailing List Page">Mailing List</A> 
<IMG SRC="../../images/arrow_yellow.gif" WIDTH=13 HEIGHT=9 ALIGN=bottom ALT="-&gt;">
<A HREF="../index.html" TITLE="tlug Archive Page">tlug archive</A> 
<IMG SRC="../../images/arrow_yellow.gif" WIDTH=13 HEIGHT=9 ALIGN=bottom ALT="-&gt;">
tlug Mailing List Archive
</SMALL></FONT>
</TD></TR>
</TABLE>
<P>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00019.html">Date Prev</a>][<a href="msg00021.html">Date Next</a>][<a href="msg00019.html">Thread Prev</a>][<a href="msg00021.html">Thread Next</a>][<a href="maillist.html#00020">Date Index</a>][<a href="threads.html#00020">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[tlug] Monkey vs Apache!!! Fight!</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li>Date: Wed, 6 Apr 2011 13:07:10 +0900</li>
<li><strong>From</strong>: <strong>Sach Jobb &lt;<a href="mailto:sach@DOMAIN.HIDDEN?SUBJECT=Re:%20%5Btlug%5D%20Monkey%20vs%20Apache%21%21%21%20Fight%21">sach@example.com</a>&gt;</strong></li>
<li><strong>Subject</strong>: <strong>[tlug] Monkey vs Apache!!! Fight!</strong></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hello TLUG,

&gt;From around 18:00 on friday, our main front end webserver, which runs
apache started running into problems. Specifically it suddenly gets
extremely busy, processing requests until it hits the limit, the new
clients then get a connection error message, and then if no staff
intervene (by restarting the service in time), apache just dies
entirely (no core dump either!).

I have a snap from munin of what it looks like here (# of processes):
<a  rel="nofollow" href="http://imgserv.net/f5aeed39e034b252.png">http://imgserv.net/f5aeed39e034b252.png</a>
(the skyscrapers are when the problem happens).

And here is a relevant snip from the apache access log:
(I changed the request uri to &quot;/someurl/&quot; and changed the client ip to
114.x.y.z.)

114.x.y.z - - [02/Apr/2011:17:49:03 +0900] &quot;GET /someurl/ HTTP/1.1&quot;
200 25728 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_6;
en-us) AppleWebKit/533.20.25 (KHTML, like Gecko) Version/5.0.4
Safari/533.20.27&quot;
114.x.y.z - - [02/Apr/2011:17:49:05 +0900] &quot;GET /someurl/ HTTP/1.1&quot;
200 25728 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_6;
en-us) AppleWebKit/533.20.25 (KHTML, like Gecko) Version/5.0.4
Safari/533.20.27&quot;
114.x.y.z - - [02/Apr/2011:17:49:02 +0900] &quot;GET /someurl/ HTTP/1.1&quot;
200 25728 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_6;
en-us) AppleWebKit/533.20.25 (KHTML, like Gecko) Version/5.0.4
Safari/533.20.27&quot;1
114.x.y.z - - [02/Apr/2011:17:49:11 +0900] &quot;GET /someurl/ HTTP/1.1&quot;
200 25728 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_6;
en-us) AppleWebKit/533.20.25 (KHTML, like Gecko) Version/5.0.4
Safari/533.20.27&quot;
114.x.y.z - - [02/Apr/2011:17:49:14 +0900] &quot;GET /someurl/ HTTP/1.1&quot;
200 25728 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_6;
en-us) AppleWebKit/533.20.25 (KHTML, like Gecko) Version/5.0.4
Safari/533.20.27&quot;
114.x.y.z - - [02/Apr/2011:17:49:15 +0900] &quot;GET /someurl/ HTTP/1.1&quot;
200 25728 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_6;
en-us) AppleWebKit/533.20.25 (KHTML, like Gecko) Version/5.0.4
Safari/533.20.27&quot;

If you grep and sort the log for IP and URI you'll see around 4,5
connections to the same URI from the same IP per second, with up to
3000 in total depending on when it was restarted (or when it died).

Upon better investigation of the logs, I figured out that it was
actually all coming from the same IP address (well, three of the times
correlate to the problem) and managed to temporarily fix the problem
by simply blocking that IP in the apache config. Tracking the IP back
to logins, I figured out that it was a real user, not a bot, and
managed to get in contact with him.

Speaking with him on the phone, I learned that he has a regular OCN
connection, somewhere in Tokyo, and some 10 client machines or so that
share through a cheap firewall. Most of them are macs. As far as I can
tell he wasn't doing any kind of behavior that would possibly take
apache, or any other service down. He's just a normal user. So, that
just left me with more questions... is there some sort of virus on one
of his machines? Is the cheap fw getting confused and rapid fire
sending the same request uri over and over? Is apache just buggered?

So, my questions are:
1) Has anyone else experienced this sort of behavior before, and
2) What to you do to protect apache against somebody that just
suddenly goes nuts with the connections, intentionally or not?

I should mention that this server is just a direction connection.
There is no reverse proxy, no load-balancer, no firewall or anything
else mucking around with IP in any way. I also double-checked with the
ISP at the colo just to make sure they didn't have any changes.

Comments appreciated.

BTW, I am the monkey, if you haven't figured that one out yet....
(pointless reference: <a  rel="nofollow" href="http://www.youtube.com/watch?v=I_QsCXm1vrk">http://www.youtube.com/watch?v=I_QsCXm1vrk</a>)

Cheers,
Sach

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00021" href="msg00021.html">[tlug]  Monkey vs Apache!!! Fight!</a></strong>
<ul><li><em>From:</em> Stephen J. Turnbull</li></ul></li>
<li><strong><a name="00022" href="msg00022.html">Re: [tlug] Monkey vs Apache!!! Fight!</a></strong>
<ul><li><em>From:</em> Raymond Wan</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00019.html">Re: [tlug] git and sub-directories</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00021.html">[tlug]  Monkey vs Apache!!! Fight!</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00019.html">Re: [tlug] git and sub-directories</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00021.html">[tlug]  Monkey vs Apache!!! Fight!</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00020"><strong>Date</strong></a></li>
<li><a href="threads.html#00020"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<strong>
<a href="../index.html">Home</a> |
<a href="maillist.html">Main Index</a> |
<a href="threads.html">Thread Index</a>
</strong>
<!--X-User-Footer-End-->
 
<P>
<CENTER>
 <table border=2 width=75%><tr><td align=center>
<a href="../../index.html"> Home Page</a></td>
<td align=center><a href="/list.html"> Mailing List </a></td>
<td align=center><a href="http://tlug.jp/linuxinjapan.html"> Linux and Japan </a></td>
<td align=center><a href="http://tlug.jp/members.html">TLUG Members</a></td>
<td align=center><a href="http://tlug.jp//linuxlinks.html">Links</a></td>
</tr></TABLE>
<P>
</CENTER>
</BLOCKQUOTE>
</body>
</html>
